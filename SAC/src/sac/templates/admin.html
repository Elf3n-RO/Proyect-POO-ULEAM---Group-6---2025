<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>SIGACC Web - Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <header>
        <div class="imagen"></div>
        <div class="container">
            <p class="logo">SAC</p>
            <nav>
                {% if admin_logeado %}
                    <a href="/config-page">Configuraci√≥n ‚öôÔ∏è</a>
                    <a href="/">Cerrar Sesi√≥n ‚èª</a>
                {% endif %}
            </nav>
        </div>
    </header>

    <section id="principal" style="height: auto; min-height: 80vh; padding-bottom: 50px;">
    <div class="container">    
        {% if not admin_logeado %}
            <h1>Bienvenido al Sistema de Asignaci√≥n de Cupos</h1>
            <form action="/login" method="POST" class="POST">
                <label for="correo">‚úâÔ∏è Correo Institucional</label>
                <input type="email" id="correo" name="correo" required>
                <label for="contrasena">üîí Contrase√±a</label>
                <input type="password" id="contrasena" name="contrasena" required>
                <button type="submit">Iniciar Sesi√≥n</button>
            </form>
        {% else %}
            <h1 style="text-align: center; margin-bottom: 30px;">Panel de Administraci√≥n SAC</h1>

            <details open style="margin-bottom: 20px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <summary class="titulo-seccion" style="cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between;">
                    üè∑Ô∏è Ofertas Acad√©micas
                    <span style="font-size: 0.7em;">(Haz clic para contraer/expandir)</span>
                </summary>
                
                <div style="padding: 15px;">
                    <table class="tabla-datos">
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Carrera</th>
                                <th>Cupos Totales</th>
                                <th>Disponibles</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for carrera in carreras %}
                            <tr>
                                <td style="font-family: monospace; font-weight: bold;">{{ carrera.codigo }}</td>
                                <td>{{ carrera.nombre }}</td>
                                <td>{{ carrera.cuposTotales }}</td>
                                <td><strong style="color: #d32f2f;">{{ carrera.cuposDisponibles }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </details>
                
                <details style="margin-bottom: 20px; border-radius: 10px;">
                    <summary class="titulo-seccion" style="cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between;">
                        üë• Postulantes y Estados de Asignaci√≥n
                        <span style="font-size: 0.7em;">(Haz clic para contraer/expandir)</span>
                    </summary>
                    <div style="padding: 15px;">
                        <table class="tabla-datos">
                            <thead>
                                <tr>
                                    <th>Identificaci√≥n</th>
                                    <th>Postulante</th>
                                    <th>Puntaje</th>
                                    <th>Vulnerabilidad</th>
                                    <th>Fecha de registro</th>
                                    <th>Asignaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for p in postulantes %}
                                <tr>
                                    <td>{{ p.identificacion }}</td>
                                    <td>{{ p.nombres }} {{ p.apellidos }}</td>
                                    <td><strong>{{ p.puntaje }}</strong></td>
                                    <td>{{ p.vulnerabilidad }}</td>
                                    <td>{{ p.fecha_inscripcion.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                    {% if p.codigo_carrera %}
                                        <b style="color: green;">ASIGNADO ({{ p.codigo_carrera }})</b>
                                    {% else %}
                                        <span style="color: gray;">Proceso Pendiente</span>
                                    {% endif %}
                                </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </details>

               <div style="text-align: center; margin-top: 30px;">
                    <form action="/ejecutar-asignacion" method="POST" onsubmit="return mostrarCarga()">
                        <button type="submit" id="btnAsignar" class="btn-logica">
                            üöÄ Ejecutar Asignaci√≥n de Cupos (Art. 51)
                        </button>
                    </form>
                    
                    <div id="msgCarga" style="display:none; margin-top: 20px;">
                        <div class="spinner"></div> <p style="color: #ffc107; font-weight: bold; font-size: 1.2em;">
                            ‚è≥ Procesando asignaciones y actualizando SQL Server... por favor espere.
                        </p>
                    </div>
                </div>

                <script>
                function mostrarCarga() {
                    // Ocultar el bot√≥n para evitar doble clic
                    document.getElementById('btnAsignar').style.display = 'none';
                    // Mostrar el mensaje de carga
                    document.getElementById('msgCarga').style.display = 'block';
                    return true; // Permite que el formulario se env√≠e
                }
                </script>

            </div>

            </div>
            <h2 class="titulo-seccion" style="text-align: left; margin-top: 40px; margin-bottom: 20px; margin-left: 40px;">üìú Historial de Ejecuciones</h2>
            <div class="contenedor-historial" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px;">
                {% for h in historial %}
                <a href="/historial/{{ h.id_proceso }}" style="text-decoration: none;">
                    <div class="card-historial" style="background: rgba(44, 62, 80, 0.9); border-radius: 12px; padding: 20px; border-left: 6px solid #d32f2f; box-shadow: 0 4px 15px rgba(0,0,0,0.3); transition: transform 0.2s;">
                        <div style="color: white;">
                            <h3 style="margin: 0 0 10px 0; color: #d32f2f;">Ejecuci√≥n #{{ h.id_proceso }}</h3>
                            <p style="margin: 5px 0;">üìÖ <b>Fecha:</b> {{ h.fecha_ejecucion.strftime('%Y-%m-%d %H:%M') }}</p>
                            <p style="margin: 5px 0;">üéì <b>Asignados:</b> {{ h.cupos_asignados }} Estudiantes</p>
                            <p style="margin: 5px 0;">üë§ <b>Responsable:</b> {{ h.usuario_responsable }}</p>
                            <hr style="border: 0.5px solid rgba(255,255,255,0.1); margin: 15px 0;">
                            <p style="text-align: right; font-size: 0.9em; font-weight: bold; margin: 0; color: #d32f2f;">Ver lista de estudiantes ‚Üí</p>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>

            <style>
                .card-historial:hover {
                    transform: translateY(-5px);
                    background: rgba(52, 73, 94, 1) !important;
                }
            </style>
        {% endif %}
    </section>

    <section id="ayuda">
        <div class="container">
            <nav>
                {% if admin_logeado %}

                    <form action="/report-page" method="POST">
                        <button type="submit">üìä Generar Reportes</button>

                    </form>
                {% else %}
                    <a href="/soporte">üõ†Ô∏èSoporte t√©cnico</a>
                    <a href="/ayuda">üö®¬øNecesitas Ayuda?</a>
                {% endif %}
            </nav>
        </div>
    </section>
</body>
</html>
